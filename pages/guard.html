<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://www.google.com; connect-src 'self' https://raw.githubusercontent.com https://api.telegram.org;">
    <link rel="stylesheet" href="../css/style.css">
    <title>ØµÙØ­Ø© Ø§Ù„Ø¬Ø§Ø±Ø¯ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
    <script src="../js/ui_helpers.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            padding: 20px;
        }

        h2 {
            text-align: center;
            color: #333;
        }

        .box {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        input,
        button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 15px;
        }

        button {
            background: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }

        th {
            background: #007bff;
            color: #fff;
        }

        .delete {
            background: #dc3545;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }

        .delete:hover {
            background: #b52a37;
        }

        td.cursor-pointer {
            cursor: pointer;
        }

        td.low-stock small {
            color: red;
        }

        .maintenance-sales-section {
            margin-top: 30px;
        }

        .maintenance-sales-section h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .maintenance-sales-table th {
            background: #667eea;
        }

        .maintenance-sales-table tr:hover {
            background: #f0f0f0;
        }

        .maintenance-indicator {
            display: inline-block;
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
        }

        .status-ØªÙ… {
            background: #28a745;
        }

        .status-ØªØ­Øª-Ø§Ù„ØªÙ†ÙÙŠØ° {
            background: #ffc107;
            color: #333;
        }

        .status-Ù„Ù…-ÙŠØªÙ… {
            background: #dc3545;
        }
    </style>
</head>

<body>

    <h2 id="guardTitle" style="cursor:pointer">ğŸ›¡ï¸ ØµÙØ­Ø© Ø§Ù„Ø¬Ø§Ø±Ø¯ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

    <div class="box">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
        <input type="text" id="name">

        <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input type="number" id="qty">

        <label>Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
        <input type="number" id="price">

        <button onclick="addProduct()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
    </div>

    <div class="box">
        <h3 style="text-align:center; color:#007bff;">ğŸ“¦ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="products"></tbody>
        </table>
    </div>

    <div class="box maintenance-sales-section">
        <h2>ğŸ”§ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© (Ù…ØªØ²Ø§Ù…Ù†Ø© Ù„Ø­Ø¸ÙŠØ§Ù‹)</h2>
        <table class="maintenance-sales-table">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="maintenanceSales"></tbody>
        </table>
        <div id="maintenanceTotal"
            style="text-align:center; font-size:18px; font-weight:bold; margin-top:15px; color:#667eea;">
            ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©: 0 Ø¬Ù†ÙŠÙ‡
        </div>
    </div>

    <div class="box" id="monthlySales" style="text-align:center;font-size:18px;font-weight:bold; margin-top:15px;">
        ğŸ’° Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±: 0 Ø¬Ù†ÙŠÙ‡
    </div>

    <div class="box" style="text-align:center;">
        <button onclick="exportMonthlyExcel()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø± (Excel)</button>
    </div>

    <div class="back-btn">
        <a href="index.html" class="btn">ğŸ  Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>

    <script>
        const DELETE_PASSWORD = "11225588";

        // Ù‡Ø¬Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø¬Ø§Ø±Ø¯ Ø§Ù„Ù…Ø³ØªÙ‚Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        if (!localStorage.getItem("guardMaintenanceSales")) {
            const oldRepairs = localStorage.getItem("repairs");
            if (oldRepairs) {
                localStorage.setItem("guardMaintenanceSales", oldRepairs);
            }
        }

        let products = JSON.parse(localStorage.getItem("products")) || [];

        // Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer') || createNotificationContainer();
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span>${message}</span>`;
            container.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s forwards';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        function createNotificationContainer() {
            const container = document.createElement('div');
            container.id = 'notificationContainer';
            container.className = 'notification-container';
            document.body.appendChild(container);
            return container;
        }

        function setFocus() {
            const input = document.getElementById("pName");
            if (input) {
                input.focus();
                input.select();
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø®ØµØµ - Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ù„Ù€ prompt
        function showInputModal(title, defaultValue, callback) {
            const overlay = document.createElement('div');
            overlay.className = 'custom-modal-overlay';
            overlay.innerHTML = `
                <div class="custom-modal">
                    <h3>${title}</h3>
                    <input type="text" id="modalInput" value="${defaultValue || ''}">
                    <div class="modal-buttons">
                        <button class="btn-confirm" id="modalConfirm">ØªØ£ÙƒÙŠØ¯</button>
                        <button class="btn-cancel" id="modalCancel">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            const input = document.getElementById('modalInput');
            input.focus();
            input.select();

            document.getElementById('modalConfirm').onclick = () => {
                const val = input.value;
                overlay.remove();
                callback(val);
            };
            document.getElementById('modalCancel').onclick = () => {
                overlay.remove();
                callback(null);
            };
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); callback(null); };
        }

        async function asyncPrompt(title, defaultValue) {
            return new Promise(resolve => {
                showInputModal(title, defaultValue, resolve);
            });
        }

        products.forEach(p => {
            if (p.totalQty === undefined) {
                p.totalQty = p.qty;
            }
        });
        save();

        function save() {
            localStorage.setItem("products", JSON.stringify(products));
        }

        function show() {
            let tbody = document.getElementById("products");
            tbody.innerHTML = "";

            products.forEach((p, i) => {
                tbody.innerHTML += `
            <tr style="background:${p.qty <= 5 ? '#fff3cd' : 'white'}">
                <td class="cursor-pointer" onclick="increaseQty(${i})">
                    ${p.name}
                    ${p.qty === 0 ? '<br><small>(Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© ÙƒÙ…ÙŠØ©)</small>' : ''}
                </td>
                <td class="${p.qty <= 5 ? 'low-stock' : ''}">
                    ${p.qty}
                </td>
                <td>
                    ${p.totalQty}
                </td>
                <td>${p.price}</td>
                <td>${p.qty * p.price}</td>
                <td>
                    <button class="edit" onclick="editProduct(${i})" style="background:#28a745; margin-bottom:5px;">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="delete" onclick="removeProduct(${i})">Ø­Ø°Ù</button>
                </td>
            </tr>
        `;
            });
        }

        function addProduct() {
            let name = document.getElementById("name").value.trim();
            let qty = Number(document.getElementById("qty").value);
            let price = Number(document.getElementById("price").value);

            if (!name || isNaN(qty) || isNaN(price) || qty <= 0 || price <= 0) {
                showNotification("âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©!", "warning");
                return;
            }

            let existing = products.find(p => p.name === name);
            if (existing) {
                existing.qty += qty;
                existing.totalQty += qty;
                existing.price = price;
            } else {
                products.push({
                    name,
                    qty,
                    totalQty: qty,
                    price
                });
            }

            save();
            show();

            document.getElementById("name").value = "";
            document.getElementById("qty").value = "";
            document.getElementById("price").value = "";
            showNotification("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
            setFocus();
        }

        async function removeProduct(index) {
            showPasswordModal(async (ok) => {
                if (!ok) return;
                const confirmed = await asyncConfirm("Ù…ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ø¹Ø§ÙŠØ² ØªØ­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ");
                if (confirmed) {
                    products.splice(index, 1);
                    save();
                    show();
                    showNotification("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
                }
            });
        }

        async function editProduct(index) {
            showPasswordModal(async (ok) => {
                if (!ok) return;
                let p = products[index];

                let newName = await asyncPrompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:", p.name);
                if (newName === null) return;

                let newQtyRaw = await asyncPrompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:", p.qty);
                const newQty = Number(newQtyRaw);
                if (newQtyRaw === null || isNaN(newQty)) return;

                let newTotalQtyRaw = await asyncPrompt("ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©:", p.totalQty);
                const newTotalQty = Number(newTotalQtyRaw);
                if (newTotalQtyRaw === null || isNaN(newTotalQty)) return;

                let newPriceRaw = await asyncPrompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±:", p.price);
                const newPrice = Number(newPriceRaw);
                if (newPriceRaw === null || isNaN(newPrice)) return;

                p.name = newName;
                p.qty = newQty;
                p.totalQty = newTotalQty;
                p.price = newPrice;

                save();
                show();
                showNotification("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
            });
        }

        async function increaseQty(index) {
            showPasswordModal(async (ok) => {
                if (!ok) return;
                let addedRaw = await asyncPrompt("Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªØ²ÙˆØ¯Ù‡Ø§:", "0");
                const added = Number(addedRaw);
                if (addedRaw === null || added <= 0 || isNaN(added)) {
                    showNotification("âŒ ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©", "error");
                    return;
                }
                products[index].qty += added;
                products[index].totalQty += added;
                save();
                show();
                showNotification("âœ… ØªÙ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©");
            });
        }

        function showMaintenanceSales() {
            const repairs = JSON.parse(localStorage.getItem("guardMaintenanceSales")) || [];
            const tbody = document.getElementById("maintenanceSales");
            tbody.innerHTML = "";

            let maintenanceTotal = 0;

            if (repairs.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align:center; color:#999; padding:20px;">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØµÙŠØ§Ù†Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
                </td>
            </tr>
        `;
            } else {
                repairs.forEach((repair) => {
                    const total = Number(repair.price);

                    if (repair.status === "ØªÙ…") {
                        maintenanceTotal += total;
                    }

                    let statusClass = 'status-' + (repair.status ? repair.status.replace(/\s+/g, '-') : 'Ù„Ù…-ÙŠØªÙ…');

                    tbody.innerHTML += `
                <tr style="opacity: ${repair.status === 'ØªÙ…' ? '1' : '0.7'}">
                    <td>${repair.customerName}</td>
                    <td>${repair.phoneModel || '-'}</td>
                    <td>${repair.problem}</td>
                    <td>${repair.price} Ø¬.Ù…</td>
                    <td><span class="maintenance-indicator ${statusClass}">${repair.status || 'Ù…Ø¹Ù„Ù‚'}</span></td>
                    <td>${repair.date}</td>
                    <td>${repair.status === 'ØªÙ…' ? total + ' Ø¬.Ù…' : '-'}</td>
                    <td><button class="delete" onclick="deleteMaintenanceSale(${repair.id})">Ø­Ø°Ù</button></td>
                </tr>
            `;
                });
            }

            document.getElementById("maintenanceTotal").innerHTML =
                `ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: ${maintenanceTotal.toLocaleString()} Ø¬Ù†ÙŠÙ‡`;

            return maintenanceTotal;
        }

        async function deleteMaintenanceSale(id) {
            showPasswordModal(async (ok) => {
                if (!ok) return;
                const confirmed = await asyncConfirm("Ù…ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ø¹Ø§ÙŠØ² ØªØ­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¯ÙŠ Ù…Ù† Ø§Ù„Ø¬Ø§Ø±Ø¯ØŸ");
                if (confirmed) {
                    let guardSales = JSON.parse(localStorage.getItem("guardMaintenanceSales")) || [];
                    guardSales = guardSales.filter(r => r.id !== id);
                    localStorage.setItem("guardMaintenanceSales", JSON.stringify(guardSales));
                    showMonthlySales();
                    showNotification("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¬Ø§Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
                }
            });
        }

        function showMonthlySales() {
            let productsTotal = products.reduce((sum, p) => {
                let soldQty = p.totalQty - p.qty;
                return sum + soldQty * p.price;
            }, 0);

            let maintenanceTotal = showMaintenanceSales();
            let grandTotal = productsTotal + maintenanceTotal;

            document.getElementById("monthlySales").innerHTML =
                `ğŸ’° Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„ÙƒÙ„ÙŠØ© (Ù…Ù†ØªØ¬Ø§Øª ${productsTotal.toLocaleString()} + ØµÙŠØ§Ù†Ø© ${maintenanceTotal.toLocaleString()}): ${grandTotal.toLocaleString()} Ø¬Ù†ÙŠÙ‡`;
        }

        show();
        showMonthlySales();

        window.addEventListener('storage', (e) => {
            if (e.key === 'repairs' || e.key === 'maintenanceUpdate' || e.key === 'guardUpdate' || e.key === 'guardMaintenanceSales') {
                console.log('ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¬Ø§Ø±Ø¯');
                showMonthlySales();
            }
        });

        setInterval(() => {
            const currentRepairs = localStorage.getItem("repairs");
            if (currentRepairs !== window.lastRepairsData) {
                window.lastRepairsData = currentRepairs;
                showMonthlySales();
            }
        }, 1000);

        window.lastRepairsData = localStorage.getItem("repairs");

        function showPasswordModal(callback) {
            let existing = document.getElementById('passwordModal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'passwordModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;';
            modal.innerHTML = `
        <div style="background:white;padding:20px;border-radius:8px;text-align:center;">
            <h2>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <input type="password" id="passwordInput" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="padding: 10px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc;">
            <div>
                <button id="submitPassword" style="padding:10px 20px;margin-right:10px;background-color:#3498db;color:white;border:none;border-radius:6px;cursor:pointer;">Ø¥Ø±Ø³Ø§Ù„</button>
                <button id="cancelPassword" style="padding:10px 20px;background-color:#e74c3c;color:white;border:none;border-radius:6px;cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    `;
            document.body.appendChild(modal);

            document.getElementById('submitPassword').addEventListener('click', () => {
                const entered = document.getElementById('passwordInput').value;
                if (entered === DELETE_PASSWORD) {
                    modal.remove();
                    callback(true);
                } else {
                    showNotification("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!", "error");
                }
            });

            document.getElementById('cancelPassword').addEventListener('click', () => {
                modal.remove();
                callback(false);
            });
        }

        // âœ… ØªØµØ¯ÙŠØ± Excel Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ÙƒØ§ÙØ© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬
        function exportMonthlyExcel() {
            const repairs = JSON.parse(localStorage.getItem("guardMaintenanceSales")) || [];

            if (products.length === 0 && repairs.length === 0) {
                showNotification("âš ï¸ Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª ØªØªØµØ¯Ø±", "warning");
                return;
            }

            const timestamp = new Date().toLocaleString('ar-EG');

            // Ø¥Ø¶Ø§ÙØ© BOM Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¹ Excel
            let csvContent = "\uFEFF";
            csvContent += "sep=,\n"; // Ø¥Ø®Ø¨Ø§Ø± Excel Ø£Ù† Ø§Ù„ÙØ§ØµÙ„ Ù‡Ùˆ Ø§Ù„ÙØ§ØµÙ„Ø©

            // --- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© ---
            csvContent += "\"ğŸ“¦ ØªÙ‚Ø±ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª\"\n";
            csvContent += "\"#\",\"Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬\",\"Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©\",\"Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©\",\"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©\",\"Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©\",\"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ\"\n";

            let productsGrandTotal = 0;
            products.forEach((p, index) => {
                let soldQty = p.totalQty - p.qty;
                let totalPrice = soldQty * p.price;
                productsGrandTotal += totalPrice;
                csvContent += `"${index + 1}","${p.name}","${soldQty}","${p.qty}","${p.totalQty}","${p.price}","${totalPrice}"\n`;
            });
            csvContent += `,"","","","","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:","${productsGrandTotal}"\n\n`;

            // --- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© ---
            if (repairs.length > 0) {
                csvContent += "\"ğŸ”§ ØªÙ‚Ø±ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©\"\n";
                csvContent += "\"#\",\"Ø§Ù„Ø¹Ù…ÙŠÙ„\",\"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\",\"Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù†ÙˆØ¹\",\"Ø§Ù„Ø³Ø¹Ø±\",\"Ø§Ù„Ø­Ø§Ù„Ø©\",\"Ø§Ù„ØªØ§Ø±ÙŠØ®\",\"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙƒØªÙ…Ù„\"\n";

                let maintenanceGrandTotal = 0;
                repairs.forEach((r, index) => {
                    let price = Number(r.price) || 0;
                    let displayTotal = r.status === "ØªÙ…" ? price : 0;
                    if (r.status === "ØªÙ…") maintenanceGrandTotal += price;

                    csvContent += `"${index + 1}","${r.customerName}","${r.phoneModel || '-'}","${r.problem}","${price}","${r.status}","${r.date}","${displayTotal}"\n`;
                });
                csvContent += `,"","","","","","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©:","${maintenanceGrandTotal}"\n\n`;
            }

            // --- Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ---
            const finalTotal = productsGrandTotal + (repairs.filter(r => r.status === "ØªÙ…").reduce((s, r) => s + Number(r.price), 0));
            csvContent += "\"ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø£Ø±Ø¨Ø§Ø­:\",\"" + finalTotal + " Ø¬Ù†ÙŠÙ‡\"\n";
            csvContent += "\"ØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:\",\"" + timestamp + "\"\n";

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const today = new Date().toLocaleDateString('ar-EG').replace(/\//g, '-');

            link.setAttribute("href", url);
            link.setAttribute("download", `ØªÙ‚Ø±ÙŠØ±_Ù…Ø¨ÙŠØ¹Ø§Øª_${today}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø§Ø­ØªØ±Ø§ÙÙŠØ©!");
        }

        // --- Ù…ÙŠØ²Ø© ØªØµÙÙŠØ± Ø§Ù„Ø´Ù‡Ø± ---
        let titleClickCount = 0;
        let titleClickTimer = null;
        const guardTitle = document.getElementById("guardTitle");

        guardTitle.addEventListener("click", () => {
            titleClickCount++;
            if (titleClickCount === 1) {
                titleClickTimer = setTimeout(() => { titleClickCount = 0; }, 1000);
            }
            if (titleClickCount === 3) {
                clearTimeout(titleClickTimer);
                titleClickCount = 0;
                handleMonthlyReset();
            }
        });

        function handleMonthlyReset() {
            showPasswordModal((ok) => {
                if (!ok) return;

                // 1. ØªØµÙÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© ÙÙŠ Ø§Ù„Ø¬Ø§Ø±Ø¯
                localStorage.setItem("guardMaintenanceSales", JSON.stringify([]));

                // 2. ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø¨Ø¬Ø¹Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© = Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
                products.forEach(p => {
                    p.totalQty = p.qty;
                });
                save(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ localStorage

                // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                show();
                showMonthlySales();
                showNotification("âœ… ØªÙ… ØªØµÙÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø¨Ù†Ø¬Ø§Ø­ (Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)");
            });
        }
        /* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø§Ø²Ù… ØªØºÙŠØ±Ù‡Ø§ ÙÙ‚Ø· ===== */
        const clientID = "2"; // Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¯Ù‡
        const STATUS_URL = "https://raw.githubusercontent.com/Mahmuod556/status/refs/heads/main/status.json"; // Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· RAW Ø§Ù„Ù„ÙŠ Ù†Ø³Ø®ØªÙ‡
        /* =================================== */

        let isOffline = false;
        let isBlockedShown = false;
        let originalBodyContent = ""; // Ù‡Ù†Ø­ÙØ¸ ÙÙŠÙ‡Ø§ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ„ÙŠ

        function saveOriginalContent() {
            if (!originalBodyContent) {
                originalBodyContent = document.body.innerHTML;
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ø¨Ù‚Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        const statusOverlay = document.createElement('div');
        statusOverlay.id = 'statusOverlay';
        statusOverlay.style.cssText = 'display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; text-align:center; padding-top:50px;';
        statusOverlay.innerHTML = `
    <div id="offlineContent" style="display:none;">
        <h2 style="color:red;">âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</h2>
        <p>Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ© Ù„Ù„ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.</p>
        <button onclick="location.reload()" style="background:#0078d4; color:white; padding:10px 20px; border-radius:5px; cursor:pointer; border:none;">Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</button>
    </div>
    <div id="blockedContent" style="display:none;">
        <h2 style="color:red;">ğŸš« ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</h2>
        <p>Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.</p>
    </div>
`;
        document.body.appendChild(statusOverlay);

        function showOfflineScreen() {
            if (!isOffline) {
                isOffline = true;
                const overlay = document.getElementById('statusOverlay');
                overlay.style.display = 'block';
                document.getElementById('offlineContent').style.display = 'block';
                document.getElementById('blockedContent').style.display = 'none';
            }
        }

        function showBlockedScreen() {
            if (!isBlockedShown) {
                isBlockedShown = true;
                const overlay = document.getElementById('statusOverlay');
                overlay.style.display = 'block';
                document.getElementById('blockedContent').style.display = 'block';
                document.getElementById('offlineContent').style.display = 'none';
            }
        }

        function restoreOriginalContent() {
            const overlay = document.getElementById('statusOverlay');
            if (overlay) overlay.style.display = 'none';
            isOffline = false;
            isBlockedShown = false;
        }

        async function checkStatusOnline() {
            // Ù†ØªØ£ÙƒØ¯ Ø§Ù† ÙÙŠÙ‡ Ø§Ù†ØªØ±Ù†Øª Ø¸Ø§Ù‡Ø±ÙŠØ§Ù‹
            if (!navigator.onLine) {
                showOfflineScreen();
                return;
            }

            // Ø­Ø§ÙˆÙ„ Ù†Ø¹Ù…Ù„ Ø·Ù„Ø¨ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù€ status.json
            try {
                const res = await fetch(STATUS_URL + "?nocache=" + Math.random(), { cache: "no-store" });
                if (!res.ok) throw new Error("status fetch failed");
                const data = await res.json();

                // Ù„Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…ØªÙˆÙ‚Ù
                if (data[clientID] === "blocked") {
                    showBlockedScreen();
                    return;
                } else {
                    // Ø§Ù„Ø¹Ù…ÙŠÙ„ active
                    // Ù„Ùˆ ÙƒÙ†Ø§ ÙÙŠ Ø´Ø§Ø´Ø© Ø§ÙˆÙÙ„Ø§ÙŠÙ† Ø£Ùˆ Ø¨Ù„ÙˆÙƒØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ
                    if (isOffline || isBlockedShown) {
                        isOffline = false;
                        isBlockedShown = false;
                        restoreOriginalContent();
                    }
                }
            } catch (e) {
                console.warn("Silent status check failed:", e);
            }
        }

        /* ÙØ­Øµ Ø§Ù„Ø´Ø¨ÙƒØ© Ø¨Ø·Ø±ÙŠÙ‚Ø© ØµØ§Ù…ØªØ© */
        function checkInternetFast() {
            // Ù…Ø´ Ù‡Ù†Ø¹Ù…Ù„ Ø­Ø¬Ø¨ Ù„Ù„Ø´Ø§Ø´Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù†ØªØŒ Ù‡Ù†ÙƒØªÙÙŠ Ø¨Ø§Ù„Ù„ÙˆØ¬ Ø£Ùˆ Ø¥Ø´Ø¹Ø§Ø± ØµØºÙŠØ±
            if (!navigator.onLine) {
                console.warn("Internet is offline (Silent check)");
                return;
            }
            let img = new Image();
            img.src = "https://www.google.com/favicon.ico?" + Math.random();
            img.onload = function () {
                if (isOffline) {
                    isOffline = false;
                    checkStatusOnline();
                }
            };
            img.onerror = function () {
                console.warn("Fast check failed (Silent)");
            };
        }

        // ÙØ­Øµ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
        setInterval(checkInternetFast, 5000);

        // ÙˆÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ© (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
        setInterval(checkStatusOnline, 15000);

        // ÙØ­Øµ Ø£ÙˆÙ„ Ù…Ø±Ø© Ù„Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­
        checkInternetFast();
        checkStatusOnline();
    </script>

</body>

</html>